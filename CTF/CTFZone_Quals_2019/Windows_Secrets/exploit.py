#!/usr/bin/python3

import os
import random
from Crypto.PublicKey import RSA
from Crypto.Cipher import PKCS1_v1_5
from Crypto.Cipher import AES
from struct import unpack

content = open('flag.enc', 'rb').read()
enc_aes_size = unpack('<I', content[:4])[0]
enc_aes_size -= 12 # remove metadata from SIMPLEBLOB format
enc_aes = content[16:enc_aes_size + 16][::-1]
enc_flag = content[enc_aes_size + 16:]


rsa_keys_dir = r"./extract"
for fname in os.listdir(rsa_keys_dir):
    rsa_key = RSA.importKey(open(rf'{rsa_keys_dir}/{fname}', 'rb').read())
    rsa_cip = PKCS1_v1_5.new(rsa_key)
    sentinel = random.randint(0, 0xffffffff)
    aes_key = rsa_cip.decrypt(enc_aes, sentinel)
    if aes_key != sentinel:
        aes_cip = AES.new(aes_key, AES.MODE_CBC, '\x00' * 16)
        print(aes_cip.decrypt(enc_flag))

